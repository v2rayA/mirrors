{
    order replace after encode
    order http_cache before reverse_proxy
}

mirrors.v2raya.org {
    handle_path /go.sh {
        redir https://hubmirror.v2raya.org/raw/v2fly/fhs-install-v2ray/master/install-release.sh
    }
    handle_path /alpine-go.sh {
        redir https://hubmirror.v2raya.org/raw/v2fly/alpinelinux-install-v2ray/master/install-release.sh
    }
    route /* {
        redir https://v2raya.org
    }
}

hubmirror.v2raya.org {
    encode zstd gzip
    replace api.github.com/repos/v2fly/ hubmirror.v2raya.org/api/v2fly/
    replace github.com/v2fly/ hubmirror.v2raya.org/v2fly/
    replace raw.githubusercontent.com/v2fly/ hubmirror.v2raya.org/raw/v2fly/
    replace raw.githubusercontent.workers.dev/v2fly/ hubmirror.v2raya.org/raw/v2fly/
    replace re "github\.com/v2fly/(.+?)/raw/" "hubmirror.v2raya.org/raw/v2fly/$1/"

    replace api.github.com/repos/mzz2017/ hubmirror.v2raya.org/api/mzz2017/
    replace github.com/mzz2017/ hubmirror.v2raya.org/mzz2017/
    replace raw.githubusercontent.com/mzz2017/ hubmirror.v2raya.org/raw/mzz2017/
    replace raw.githubusercontent.workers.dev/mzz2017/ hubmirror.v2raya.org/raw/mzz2017/
    replace re "github\.com/mzz2017/(.+?)/raw/" "hubmirror.v2raya.org/raw/mzz2017/$1/"

    @whitelist {
        path /v2fly/* /v2fly
        path /mzz2017/* /mzz2017
    }
    handle @whitelist {
        reverse_proxy https://github.com {
            header_up Host github.com
            header_up Referer mirrors.v2raya.org github.com
            header_up Accept-Encoding identity
            transport http {
                tls_server_name github.com
            }
            header_down Location github-releases.githubusercontent.com hubmirror.v2raya.org/releases
#            header_down Location github.com/v2fly/v2ray-core/releases/ hubmirror.v2raya.org/v2fly/releases/
            header_down Set-Cookie github.com mirrors.v2raya.org
            header_down -Content-Security-Policy
            header_down -Expect-Ct
            header_down X-Pjax-Url github.com hubmirror.v2raya.org
        }
    }
    @orgs_v2fly {
        path /orgs/v2fly/* /orgs/v2fly
    }
    handle @orgs_v2fly {
        reverse_proxy https://github.com {
            header_up Host github.com
            header_up Referer mirrors.v2raya.org github.com
            header_up Accept-Encoding identity
            transport http {
                tls_server_name github.com
            }
            header_down Location github-releases.githubusercontent.com hubmirror.v2raya.org/releases
            header_down Location github.com/v2fly/v2ray-core/releases/ hubmirror.v2raya.org/v2fly/releases/
            header_down Set-Cookie github.com mirrors.v2raya.org
            header_down -Content-Security-Policy
            header_down -Expect-Ct
            header_down X-Pjax-Url github.com hubmirror.v2raya.org
        }
    }

    # FIXME: vulnerability
    handle_path /releases/* {
        reverse_proxy https://github-releases.githubusercontent.com {
            header_up Host github-releases.githubusercontent.com
            header_up Referer mirrors.v2raya.org github.com
            transport http {
                tls_server_name github-releases.githubusercontent.com
            }
        }
        http_cache {
            default_max_age 720h
            cache_type file 
            path /tmp/cache
            match_path /
            cache_key "{http.request.method} {http.request.host}{http.request.uri.path}"
        }
    }
    handle_path /api/v2fly/* {
        rewrite * /repos/v2fly{path}
        reverse_proxy https://api.github.com {
            header_up Host api.github.com
            header_up Accept-Encoding identity
            header_up Referer mirrors.v2raya.org github.com
            transport http {
                tls_server_name api.github.com
            }
        }
        http_cache {
            default_max_age 24h
            cache_type file 
            path /tmp/cache
            match_path /
        }
    }
    handle_path /raw/v2fly/* {
        rewrite * /v2fly{path}
        reverse_proxy https://raw.githubusercontent.com {
            header_up Host raw.githubusercontent.com
            header_up Accept-Encoding identity
            header_up Referer mirrors.v2raya.org github.com
            transport http {
                tls_server_name raw.githubusercontent.com
            }
        }
        http_cache {
            default_max_age 24h
            cache_type file 
            path /tmp/cache
            match_path /
        }

    }
    route /* {
        redir https://v2raya.org temporary   
    }
}

